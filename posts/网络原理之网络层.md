---
title: 网络原理之网络层
description:
aside: false
date: 2022-12-22
tags:
  - 网络原理
---

在计算机网络体系结构中，网络层位于数据链路层之上、传输层之下，位于提供端到端传输层服务的协议栈底层。网络层是网络核心的最高层，是实现大型网络互连的关键，是网络体系结构中最重要的一层。
本文将介绍网络层的基本功能、典型分组交换网络、网络互连、网络层拥塞控制、Internet 网络层、路由算法与路由协议等内容。

### 一、网络层服务

**网络层核心任务**：将数据从源主机送达到目的主机

**网络层主要功能**：

**转发**：当输入链路接收到一个分组后，路由器需要决策通过哪条输出链路将分组发送出去，并将分组从输入接口转移到输出接口。
**路由选择**：当分组从源主机流向目的主机时，必须通过某种方式决定分组经过的路由或路径。
**连接建立**：网络层连接是从源主机到目的主机经过的一条路径，这条路径所经过的每个路由器等网络设备都要参与网络层连接的建立。

### 二、数据报网络与虚电路

**数据报网络（无连接服务）**：数据报网络是按照目的主机地址进行路由选择的网络。

特点：

- **无连接**

- 路由选择: **每个分组独立路由**（源主机每发送一个分组，就为该分组加上目的主机地址，然后将该分组推进网络。每个路由器使用分组的目的主机地址转发分组。）

- **按序发送、不一定按序接收**

**虚电路网络（面向连接）**

虚电路是源主机到目的主机的一条路径上建立的一条网络层逻辑连接。在网络层提供面向连接的分组交换服务。双方通信前先虚电路建立连接，通信结束后再拆除连接。

构成：

- 从源主机到目的主机之间的一条路径（一系列的链路和分组交换机）

- 该路径上的每条链路的虚电路标识（VCID）

- 分组交换机的转发表中记录虚电路标识的接续关系

#### 数据报网络与虚电路网络的区别

| 项目     | 数据报网络         | 虚电路网络                       |
| ------ | ------------- | --------------------------- |
| 是否建立连接 | 不建立连接         | 先建立连接                       |
| 地址     | 每个分组包含源和目的端地址 | 每个分组含有一个短的虚电路号              |
| 分组顺序   | 按序发送，不一定按序接收  | 按序发送，按序接收                   |
| 路由选择   | 每个分组独立路由选择    | 建立 VC 时需要路由选择，之后所有分组都沿此路由转发 |
| 典型网络   | 因特网           | X.25、帧中继、ATM                |

### 三、网络互连和网络互连设备

### 四、拥塞控制

#### ① 网络拥塞

用户对网络资源（包括链路带宽、存储空间和处理器处理能力等）的总需求超过了网络固有的容量。

**原因**：

- 缓冲区容量有限
- 传输线路的带宽有限
- 网络结点的处理能力有限
- 网络中某些部分发生了故障

#### ② 拥塞控制措施

- 流量感知路由：**权值**根据网络负载**动态**调整，可以将网络流量引导到不同的链路上，均衡网络负载。

- 准入控制

- 流量调节

- 负载脱落

### 五、Internet 网络层

#### ①IPv4 协议

**数据报格式**

#### ②IPV4 编址

- **二进制标记法**

- **点分十进制标记法**，即类似 192.168.1.101

- **十六进制标记法**

**分类地址**

- A 类地址的网络号占 8 比特，主机号占 24 比特，网络号的最高位固定为 0
- B 类地址的网络号和主机号各占 16 比特，网络号的最高两位固定为 10
- C 类地址的网络号占 24 位比特，主机号占 8 位比特，网络号最高三位固定位 110
- D 类地址是多播地址，其最高四位固定为 1110
- E 类地址是保留地址，其最高四位固定为 1111

> 主机号为全 0 的地址是网络地址，不能分配给主机或路由器的各接口
> 主机号为全 1 的地址是广播，不能分配给主机或路由器的各接口

**子网划分**

> 为什么要子网划分

- 满足不同网络对IP地址的需求

- 实现网络的层次化

- 节省IP地址

- 默认子网掩码可以进一步划分，称为可变长子网掩码“VLSM”

- **有类IP地址规划的缺陷：使用默认掩码的问题：地址范围过大或过小，导致IP地址的浪费！**

**路由聚合**

是把一组路由汇聚为一个单个的路由广播。路由汇聚的最终结果和最明显的好处是缩小网络上的路由表的尺寸。

**子网划分是为了让我们拥有更小的网络，每个网络的主机数可以放得少一些。超网则是让我们把这些单块儿的小网络聚合，让一个网段儿能放更多的主机数。**

#### ③ 动态主机配置协议

- 动态主机配置协议，即**DHCP**

- 提供动态 IP 地址分配的网络，需要运行**DHCP 服务器，端口号为 67**。并且配置其可以为其他主机动态分配的 IP 地址范围

- 当一台主机接入网络或重新启动时，便运行**DHCP 客户（端口 68）**，申请 DHCP 服务器为其分配 IP 地址

#### ④ 网络地址转换

- NAT 即网络地址转换

- NAT 通常运行在私有网络的边缘路由器上，同时连接内部私有网络和公共互联网，拥有公共 IP 地址。

- 工作原理：NAT 通过替换进出内部私有网络的 IP 数据报的 IP 地址和端口，支持使用私有地址的内部主机与公共互联网中的服务器与其他主机通信。

- NAT 可以有效的支持私有地址的内网主机主动发起与公共互联网的通信，但是却不能被动接受外网主机主动与内网主机通信。因为如果 NAT 转化表中没有外网到内网的映射，内网主机对外网来说是不可见的。

- NAT 穿透技术就是用来解决内网主机对外网主机不可见这一问题。

- 所谓 NAT 穿透技术，就是在外网主动与内网主机发起通信之前，先告诉 NAT 转换表中建立好内网到外网的映射，是内网运行的服务以 NAT 公司网址的合法身份暴露出去。

- 如何在 NAT 转换表中建立内网到外网的映射？
  **静态配置**：静态配置就是通过人工手动配置 NAT 转换表，建立内网到外网的映射。
  **动态配置**：内网主机主动发现 NAT，并请求 NAT 完成穿透配置。比较典型的是基于 UPnP 协议实现自动 NAT 穿透配置

#### ⑤ICMP

- ICMP 即互联网控制报文协议

- ICMP 的主要目的是将主机或路由器在处理或转发 IP 数据报的过程中发生的 异常情况反馈给其他主机或路由器，实现差错信息报告

- ICMP 的主要功能是进行主机或路由器的网络层差错报告和网络探测

- ICMP 通过发送 ICMP 报文，实现差错报告或网络探询功能，因此 ICMP 报文分为差错报告报文和探询报文两大类

#### ⑥IPV6

- NAT 缓解了 IPv4 地址耗尽的问题，使得没有公共网络 IP 地址的设备也可以上网。但终究只是过渡技术。

- **IPv6**是解决 IPv4 问题的理想方案

- IPv6 数据报格式。**IPv6 首部长度固定位 40 字节**

- IPv6 地址长度为 128 位，通常采用 8 组分隔的十六制数地址形式表示

- IPv6 压缩格式：可以使用（::）代替连续的多组全为 0 的分组,但是在一个 IPv6 地址中只能使用一次省略符

- 也可以使用 IPv6 嵌套 IPv4 地址的表达形式：即 IPv6 中的低 32 位写成点分十进制。

- IPv6 地址包括单播地址，组播地址和任播地址
  （1）单播地址：唯一标识一个主机或路由器网络接口
  （2）组播地址：标识一组主机
  （3）任播地址：标识一组主机，发送消息时只有该任播地址标识的任播组的某个成员可以收到

- IPv4 到 IPv6 的迁移方案：
  （1）双协议栈：即同时支持 IPv4 和 IPv6
  （2）解决 IPv6 到 IPv4 转换时信息丢失办法：在 IPv4 上建立 IPv6 隧道，即隧道技术
